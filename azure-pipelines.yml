trigger:
  - main
  - refs/tags/*

pr:
  - main

pool:
  vmImage: 'windows-2019'

variables:
  buildConfiguration: 'Release'
  netSdkPath: 'sdk/dotnet'
  netSdkSolution: '$(netSdkPath)/Datasync.Framework.sln'
  BASE_VERSION: 5.0.0
  PREVIEW_LABEL: 'preview'
  BUILD_NUMBER: $[counter(format('{0}_{1}_{2}', variables['BASE_VERSION'], variables['PREVIEW_LABEL'], variables['Build.SourceBranch']), 1)]
  NUGET_VERSION: $[format('{0}-{1}.{2}', variables['BASE_VERSION'], variables['PREVIEW_LABEL'], variables['BUILD_NUMBER'])]

stages:
  - stage: build
    displayName: Build SDK
    jobs:
      - job: buildnetsdk
        displayName: Build .NET SDK
        steps:
          - task: UseDotNet@2
            inputs:
              version: '5.0.x'
              performMultiLevelLookup: true

          - task: NuGetToolInstaller@1
            inputs:
              checkLatest: true
          
          - task: MSBuild@1
            displayName: 'Build SDK'
            inputs:
              configuration: $(buildConfiguration)
              solution: $(netSdkSolution)
              msBuildArguments: '/nologo /t:Restore;Build;Pack /p:PackageVersion=$(NUGET_VERSION) /p:Version=$(BASE_VERSION) /bl /clp:DisableConsoleColor;Verbosity:normal;PerformanceSummary /fl'

          - task: PublishBuildArtifacts@1
            displayName: Publish Build Artifacts
            inputs:
              pathToPublish: $(netSdkPath)
              artifactName: build
              fileCopyOptions: 'bin obj /s /fp'

          - task: VSTest@2
            displayName: 'Run Unit Tests'
            inputs:
              testAssemblyVer2: '**\Microsoft.*.Test.dll'
              searchFolder: $(netSdkPath)
              codeCoverageEnabled: true
              diagnosticsEnabled: true
              configuration: $(buildConfiguration)

          - task: PublishBuildArtifacts@1
            displayName: Publish Test Artifacts
            inputs:
              pathToPublish: $(netSdk)/TestResults
              artifactName: test
              fileCopyOptions: '/s /fp'

          - task: DotNetCoreCLI@2
            displayName: 'Build Template'
            inputs:
              command: pack
              projects: '$(netSdkPath)/templates/*.csproj'
              configuration: $(buildConfiguration)

          - task: PublishBuildArtifacts@1
            displayName: Publish NuGet Packages
            inputs:
              pathToPublish: $(netSdk)
              artifactName: nuget
              fileCopyOptions: '*.nupkg /s /fp'
