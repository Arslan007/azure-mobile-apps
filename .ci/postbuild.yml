parameters:
  sourceDirectory: '.'
  buildConfiguration: 'Release'
  buildArtifactDirectory: '$(Build.ArtifactStagingDirectory)'
  nugetArtifactDirectory: 'output-nuget'
  buildArtifacts: '*Datasync*.dll,*Datasync*.pdb,*.binlog'
  nugetArtifacts: '*.nupkg,*.nuspec'
  
steps:
  - pwsh: |
      Get-ChildItem -Path '${{ parameters.sourceDirectory }}' -Directory -Recurse | Where-Object { $_.FullName -match '\\(bin|obj)\\${{ parameters.buildConfiguration }}$' } | Write-Host
    displayName: Show Build Directories

  - pwsh: |
      New-Item -Force -Path '$(Build.ArtifactStagingDirectory)' -ItemType Directory
      New-Item -Force -Path '${{ parameters.nugetArtifactDirectory }}' -ItemType Directory
    displayName: Create Artifacts Storage

  - pwsh: |
        Get-ChildItem -Path '${{ parameters.sourceDirectory }}' -Directory -Recurse | \
          Where-Object { $_.FullName -match '\\(bin|obj)\\${{ parameters.buildConfiguration }}$' } | \
          Foreach { Get-ChildItem -Path $_ -Include ${{ parameters.buildArtifacts }} | Copy-Item -Destination '${{ parameters.buildArtifactDirectory }}' -PassThru | Write-Host }
    displayName: Consolidate build artifacts

  - pwsh: |
        Get-ChildItem -Path '${{ parameters.sourceDirectory }}' -Directory -Recurse | \
          Where-Object { $_.FullName -match '\\(bin|obj)\\${{ parameters.buildConfiguration }}$' } | \
          Foreach { Get-ChildItem -Path $_ -Include ${{ parameters.nugetArtifacts }} | Copy-Item -Destination '${{ parameters.nugetArtifactDirectory }}' -PassThru | Write-Host }
    displayName: Consolidate NuGet artifacts

  - task: PublishBuildArtifacts@1
    displayName: Publish Build Artifacts
    inputs:
      pathToPublish: '${{ parameters.buildArtifactDirectory }}'
      artifactName: build

  - task: PublishBuildArtifacts@1
    displayName: Publish NuGet Packages
    inputs:
      PathtoPublish: ${{ parameters.nugetArtifactDirectory }}
      artifactName: nuget